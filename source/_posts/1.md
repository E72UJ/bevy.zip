---
title: Raven缩放系统
date: 2025-11-07 22:17:02
tags:
---
```rust
use bevy::prelude::*;
use bevy::window::WindowResized;

// === 核心资源 ===
#[derive(Resource)]
pub struct VirtualCanvas {
    pub width: f32,
    pub height: f32,
}

#[derive(Resource)]
pub struct ScaleInfo {
    pub scale: f32,
    pub offset_x: f32,
    pub offset_y: f32,
}

// === 字体资源 ===
#[derive(Resource)]
pub struct GameFont {
    pub handle: Handle<Font>,
}

// === 可缩放组件 ===
#[derive(Component)]
pub struct Scalable {
    pub original_width: f32,
    pub original_height: f32,
    pub original_font_size: Option<f32>,
    pub original_margin: UiRect,
}

impl Scalable {
    pub fn new() -> Self {
        Self {
            original_width: 0.0,
            original_height: 0.0,
            original_font_size: None,
            original_margin: UiRect::all(Val::Px(0.0)),
        }
    }

    pub fn with_size(mut self, width: f32, height: f32) -> Self {
        self.original_width = width;
        self.original_height = height;
        self
    }

    pub fn with_font_size(mut self, font_size: f32) -> Self {
        self.original_font_size = Some(font_size);
        self
    }

    pub fn with_margin(mut self, margin: UiRect) -> Self {
        self.original_margin = margin;
        self
    }
}

// === 插件 ===
pub struct SimpleScalePlugin;

impl Plugin for SimpleScalePlugin {
    fn build(&self, app: &mut App) {
        app
            .insert_resource(VirtualCanvas {
                width: 1280.0,  // 虚拟分辨率
                height: 720.0,
            })
            .insert_resource(ScaleInfo { 
                scale: 1.0,
                offset_x: 0.0,
                offset_y: 0.0,
            })
            .add_systems(Startup, (load_font, setup_ui).chain()) // 先加载字体，再设置UI
            .add_systems(Update, handle_window_resize);
    }
}

// === 加载字体 ===
fn load_font(mut commands: Commands, asset_server: Res<AssetServer>) {
    let font_handle = asset_server.load("fonts/SarasaFixedHC-Light.ttf");
    commands.insert_resource(GameFont {
        handle: font_handle,
    });
    println!("正在加载字体: SarasaFixedHC-Light.ttf");
}

// === 设置UI ===
fn setup_ui(mut commands: Commands, game_font: Res<GameFont>) {
    // 摄像机
    commands.spawn(Camera2d);

    // 主容器 - 虚拟屏幕的根节点
    commands
        .spawn((
            Node {
                width: Val::Px(1280.0),
                height: Val::Px(720.0),
                position_type: PositionType::Absolute,
                left: Val::Px(0.0),
                top: Val::Px(0.0),
                flex_direction: FlexDirection::Column,
                justify_content: JustifyContent::Center,
                align_items: AlignItems::Center,
                ..default()
            },
            BackgroundColor(Color::srgb(0.2, 0.2, 0.3)),
            Scalable::new().with_size(1280.0, 720.0),
        ))
        .with_children(|parent| {
            // 标题文本
            parent.spawn((
                Text::new("可缩放UI系统演示"),
                TextFont {
                    font: game_font.handle.clone(), // 使用自定义字体
                    font_size: 48.0,
                    ..default()
                },
                TextColor(Color::WHITE),
                Node {
                    margin: UiRect::bottom(Val::Px(30.0)),
                    ..default()
                },
                Scalable::new()
                    .with_font_size(48.0)
                    .with_margin(UiRect::bottom(Val::Px(30.0))),
            ));

            // 中央面板
            parent
                .spawn((
                    Node {
                        width: Val::Px(600.0),
                        height: Val::Px(400.0),
                        flex_direction: FlexDirection::Column,
                        justify_content: JustifyContent::Center,
                        align_items: AlignItems::Center,
                        border: UiRect::all(Val::Px(2.0)),
                        ..default()
                    },
                    BackgroundColor(Color::srgb(0.1, 0.1, 0.2)),
                    BorderColor::all(Color::WHITE),
                    Scalable::new().with_size(600.0, 400.0),
                ))
                .with_children(|parent| {
                    // 面板内容
                    parent.spawn((
                        Text::new("这个面板会自动缩放"),
                        TextFont {
                            font: game_font.handle.clone(), // 使用自定义字体
                            font_size: 24.0,
                            ..default()
                        },
                        TextColor(Color::srgb(0.8, 0.8, 1.0)),
                        Node {
                            margin: UiRect::bottom(Val::Px(20.0)),
                            ..default()
                        },
                        Scalable::new()
                            .with_font_size(24.0)
                            .with_margin(UiRect::bottom(Val::Px(20.0))),
                    ));

                    // 中文测试文本
                    parent.spawn((
                        Text::new("中文字体测试 - 更纱黑体"),
                        TextFont {
                            font: game_font.handle.clone(), // 使用自定义字体
                            font_size: 20.0,
                            ..default()
                        },
                        TextColor(Color::srgb(0.9, 0.9, 0.5)),
                        Node {
                            margin: UiRect::bottom(Val::Px(20.0)),
                            ..default()
                        },
                        Scalable::new()
                            .with_font_size(20.0)
                            .with_margin(UiRect::bottom(Val::Px(20.0))),
                    ));

                    // 按钮
                    parent.spawn((
                        Button,
                        Node {
                            width: Val::Px(200.0),
                            height: Val::Px(60.0),
                            justify_content: JustifyContent::Center,
                            align_items: AlignItems::Center,
                            border: UiRect::all(Val::Px(1.0)),
                            ..default()
                        },
                        BackgroundColor(Color::srgb(0.3, 0.6, 0.3)),
                        BorderColor::all(Color::WHITE),
                        Scalable::new().with_size(200.0, 60.0),
                    ))
                    .with_children(|parent| {
                        parent.spawn((
                            Text::new("缩放按钮"),
                            TextFont {
                                font: game_font.handle.clone(), // 使用自定义字体
                                font_size: 18.0,
                                ..default()
                            },
                            TextColor(Color::WHITE),
                            Scalable::new().with_font_size(18.0),
                        ));
                    });
                });

            // 底部信息
            parent.spawn((
                Text::new("调整窗口大小查看缩放效果"),
                TextFont {
                    font: game_font.handle.clone(), // 使用自定义字体
                    font_size: 16.0,
                    ..default()
                },
                TextColor(Color::srgb(0.7, 0.7, 0.7)),
                Node {
                    margin: UiRect::top(Val::Px(40.0)),
                    ..default()
                },
                Scalable::new()
                    .with_font_size(16.0)
                    .with_margin(UiRect::top(Val::Px(40.0))),
            ));

            // 多行文本示例
            parent.spawn((
                Text::new("English + 中文混合显示\nMulti-line text test\n多行文本测试"),
                TextFont {
                    font: game_font.handle.clone(), // 使用自定义字体
                    font_size: 14.0,
                    ..default()
                },
                TextColor(Color::srgb(0.6, 0.8, 0.9)),
                Node {
                    margin: UiRect::top(Val::Px(20.0)),
                    ..default()
                },
                Scalable::new()
                    .with_font_size(14.0)
                    .with_margin(UiRect::top(Val::Px(20.0))),
            ));
        });

    // 添加一个2D精灵作为对比
    commands.spawn((
        Sprite {
            color: Color::srgb(1.0, 0.5, 0.5),
            custom_size: Some(Vec2::new(100.0, 100.0)),
            ..default()
        },
        Transform::from_translation(Vec3::new(-400.0, 0.0, 0.0)),
    ));

    println!("UI设置完成，使用字体: SarasaFixedHC-Light.ttf");
}

// === 窗口缩放处理 ===
fn handle_window_resize(
    mut resize_events: MessageReader<WindowResized>,
    mut camera_query: Query<&mut Projection, With<Camera2d>>,
    mut ui_query: Query<(&mut Node, &Scalable), Without<Text>>,
    mut text_query: Query<(&mut TextFont, &Scalable), With<Text>>,
    canvas: Res<VirtualCanvas>,
    mut scale_info: ResMut<ScaleInfo>,
) {
    for event in resize_events.read() {
        let window_width = event.width;
        let window_height = event.height;
        let virtual_width = canvas.width;
        let virtual_height = canvas.height;

        // === 计算等比缩放 ===
        let scale_x = window_width / virtual_width;
        let scale_y = window_height / virtual_height;
        let scale = scale_x.min(scale_y);

        // === 计算居中偏移 ===
        let scaled_width = virtual_width * scale;
        let scaled_height = virtual_height * scale;
        let offset_x = (window_width - scaled_width) / 2.0;
        let offset_y = (window_height - scaled_height) / 2.0;

        // 更新缩放信息
        scale_info.scale = scale;
        scale_info.offset_x = offset_x;
        scale_info.offset_y = offset_y;

        println!("窗口: {}x{}, 缩放: {:.2}, 偏移: ({:.1}, {:.1})", 
                 window_width, window_height, scale, offset_x, offset_y);

        // === 更新2D摄像机 ===
        for mut projection in camera_query.iter_mut() {
            if let Projection::Orthographic(ortho) = projection.as_mut() {
                ortho.scale = 1.0 / scale;
            }
        }

        // === 更新UI节点 ===
        for (mut node, scalable) in ui_query.iter_mut() {
            if scalable.original_width > 0.0 {
                node.width = Val::Px(scalable.original_width * scale);
            }
            if scalable.original_height > 0.0 {
                node.height = Val::Px(scalable.original_height * scale);
            }

            node.margin = scale_ui_rect(&scalable.original_margin, scale);

            if scalable.original_width == virtual_width && scalable.original_height == virtual_height {
                node.left = Val::Px(offset_x);
                node.top = Val::Px(offset_y);
            }
        }

        // === 更新文本大小 ===
        for (mut text_font, scalable) in text_query.iter_mut() {
            if let Some(original_font_size) = scalable.original_font_size {
                text_font.font_size = original_font_size * scale;
            }
        }
    }
}

// === 辅助函数 ===
fn scale_ui_rect(rect: &UiRect, scale: f32) -> UiRect {
    UiRect {
        left: scale_val(&rect.left, scale),
        right: scale_val(&rect.right, scale),
        top: scale_val(&rect.top, scale),
        bottom: scale_val(&rect.bottom, scale),
    }
}

fn scale_val(val: &Val, scale: f32) -> Val {
    match val {
        Val::Px(px) => Val::Px(*px * scale),
        Val::Percent(percent) => Val::Percent(*percent),
        _ => *val,
    }
}

// === 主函数 ===
fn main() {
    App::new()
        .add_plugins(DefaultPlugins.set(WindowPlugin {
            primary_window: Some(Window {
                title: "Raven缩放系统".into(),
                resolution: (1280, 720).into(),
                resizable: true,
                ..default()
            }),
            ..default()
        }))
        .add_plugins(SimpleScalePlugin)
        .run();
}
```