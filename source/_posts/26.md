---
title: bevy åŸºç¡€æ•°æ®
date: 2026-01-15 22:25:35
tags:
---
```rust
use bevy::prelude::*;
use crate::GameState;

#[derive(Component)]
struct PlayingEntity;

#[derive(Component)]
struct PlayingCamera;

pub struct PlayingPlugin;

const VIRTUAL_WIDTH: f32 = 1920.0;
const VIRTUAL_HEIGHT: f32 = 1080.0;

impl Plugin for PlayingPlugin {
    fn build(&self, app: &mut App) {
        app
            .add_systems(OnEnter(GameState::Playing), setup_playing)
            .add_systems(Update, handle_playing_input.run_if(in_state(GameState::Playing)))
            .add_systems(Update, update_ui_scale.run_if(in_state(GameState::Playing)))
            .add_systems(OnExit(GameState::Playing), cleanup_playing);
    }
}

fn setup_playing(
    mut commands: Commands,
    asset_server: Res<AssetServer>
) {
    // ğŸ¥ æ‘„åƒæœº


    // ğŸ¨ UIæ ¹å®¹å™¨ - é‡‡ç”¨èœå•çš„è®¾è®¡æ¨¡å¼
    commands
        .spawn((
            PlayingEntity,
            Node {
                width: Val::Percent(100.0),      // âœ… å æ»¡çª—å£
                height: Val::Percent(100.0),
                justify_content: JustifyContent::Center, // âœ… æ°´å¹³å±…ä¸­
                align_items: AlignItems::Center,         // âœ… å‚ç›´å±…ä¸­
                ..default()
            },
            BackgroundColor(Color::srgb(0.1, 0.1, 0.2)), // è°ƒè¯•ç”¨èƒŒæ™¯
        ))
        .with_children(|parent| {
            // ğŸ¯ å›ºå®šå°ºå¯¸çš„å†…å®¹åŒºåŸŸï¼ˆä¼šè¢«UiScaleç¼©æ”¾ï¼‰
            parent
                .spawn((
                    Node {
                        width: Val::Px(VIRTUAL_WIDTH),   // âœ… å›ºå®š1920px
                        height: Val::Px(VIRTUAL_HEIGHT), // âœ… å›ºå®š1080px
                        flex_direction: FlexDirection::Column,
                        border: UiRect::all(Val::Px(2.0)), // è°ƒè¯•è¾¹æ¡†
                        ..default()
                    },
                    BackgroundColor(Color::srgb(0.2, 0.2, 0.3)),
                ))
                .with_children(|parent| {
                    // ğŸ”³ ç™½è‰²èƒŒæ™¯æ¡
                    parent.spawn((
                        Node {
                            width: Val::Percent(100.0),
                            height: Val::Px(350.0),
                            position_type: PositionType::Absolute,
                            top: Val::Px(100.0),
                            ..default()
                        },
                        BackgroundColor(Color::WHITE),
                    ));

                    // ğŸ“ æ ‡é¢˜æ–‡æœ¬
                    parent.spawn((
                        Text::new("æ¸¸æˆä¸­ - æŒ‰ ESC è¿”å›èœå•"),
                        Node {
                            position_type: PositionType::Absolute,
                            top: Val::Px(200.0),
                            left: Val::Px(50.0),
                            ..default()
                        },
                        TextColor(Color::BLACK),
                        TextFont {
                            font_size: 24.0,
                            ..default()
                        },
                    ));

                    // ğŸŒ ä½ å¥½ä¸–ç•Œæ–‡æœ¬
                    parent.spawn((
                        Text::new("ä½ å¥½ä¸–ç•Œ"),
                        Node {
                            position_type: PositionType::Absolute,
                            top: Val::Px(250.0),
                            left: Val::Px(350.0),
                            ..default()
                        },
                        TextColor(Color::BLACK),
                        TextFont {
                            font: asset_server.load("fonts/SarasaFixedHC-Regular.ttf"),
                            font_size: 48.0,
                            ..default()
                        },
                    ));
                });
        });
}

fn handle_playing_input(
    keyboard_input: Res<ButtonInput<KeyCode>>,
    mut next_state: ResMut<NextState<GameState>>,
) {
    if keyboard_input.just_pressed(KeyCode::Escape) {
        next_state.set(GameState::Menu);
    }
}

fn cleanup_playing(
    mut commands: Commands,
    query: Query<Entity, With<PlayingEntity>>,
) {
    for entity in query.iter() {
        commands.entity(entity).despawn();
    }
    println!("é€€å‡ºæ¸¸æˆ");
}

fn update_ui_scale(
    windows: Query<&Window>,
    mut ui_scale: ResMut<UiScale>,
) {
    if let Some(window) = windows.iter().next() {
        let window_width = window.width();
        let window_height = window.height();
        
        let scale_x = window_width / VIRTUAL_WIDTH;
        let scale_y = window_height / VIRTUAL_HEIGHT;
        let scale = scale_x.min(scale_y);
        
        ui_scale.0 = scale;
        
        // è°ƒè¯•ä¿¡æ¯
        println!("çª—å£: {}x{}, ç¼©æ”¾: {:.2}", window_width, window_height, scale);
    }
}
```