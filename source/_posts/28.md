---
title: 28
date: 2026-01-24 02:05:38
tags:
---
```ddos
# å…³äº Script.rs + Playing.rs æ¶æ„çš„åˆ†æ

## ä½ çš„æ¶æ„è®¾è®¡

```
script.rs (å‰§æƒ…æ•°æ®å±‚)
    â†“ 
    å®å®šä¹‰å‰§æƒ…å†…å®¹
    â†“
playing.rs (æ¸²æŸ“æ‰§è¡Œå±‚)
    â†“
    è°ƒç”¨å¹¶æ¸²æŸ“å‰§æƒ…
```

## æ¶æ„åˆç†æ€§åˆ†æ

### âœ… ä¼˜ç‚¹

1. **å…³æ³¨ç‚¹åˆ†ç¦»æ˜ç¡®**
   ```rust
   // script.rs - ä¸“æ³¨å†…å®¹åˆ›ä½œ
   create_story! {
       scene "start" {
           show_background "classroom";
           show_character "student";
           say "student" "ä½ å¥½ï¼Œæ¬¢è¿æ¥åˆ°å­¦æ ¡ï¼";
       }
   }
   
   // playing.rs - ä¸“æ³¨æ¸²æŸ“é€»è¾‘
   fn process_story_commands() {
       // å¤„ç†æ¸²æŸ“ã€åŠ¨ç”»ã€äº¤äº’
   }
   ```

2. **ç¼–è¾‘å‹å¥½**
   - ç­–åˆ’/ç¼–å‰§å¯ä»¥ä¸“æ³¨ script.rs
   - ç¨‹åºå‘˜ä¸“æ³¨ playing.rs
   - äº’ä¸å¹²æ‰°

3. **ç»´æŠ¤æ€§å¥½**
   - å‰§æƒ…ä¿®æ”¹ä¸å½±å“æ¸²æŸ“ä»£ç 
   - æ¸²æŸ“ä¼˜åŒ–ä¸å½±å“å‰§æƒ…å†…å®¹

### âš ï¸ ä½†æ˜¯ï¼Œè¿™ä¸ªæ¶æ„è¿˜éœ€è¦å®Œå–„

## å»ºè®®çš„å®Œæ•´æ¶æ„

```
src/
â”œâ”€â”€ script/
â”‚   â”œâ”€â”€ mod.rs              # è„šæœ¬ç³»ç»Ÿå…¥å£
â”‚   â”œâ”€â”€ dsl.rs              # å®å®šä¹‰å’Œè¯­æ³•
â”‚   â”œâ”€â”€ commands.rs         # å‘½ä»¤æšä¸¾å®šä¹‰  
â”‚   â”œâ”€â”€ parser.rs           # è§£æå™¨ï¼ˆå¯é€‰ï¼‰
â”‚   â””â”€â”€ stories/            # å‰§æƒ…æ–‡ä»¶å¤¹
â”‚       â”œâ”€â”€ chapter1.rs     # ç¬¬ä¸€ç« å‰§æƒ…
â”‚       â”œâ”€â”€ chapter2.rs     # ç¬¬äºŒç« å‰§æƒ…
â”‚       â””â”€â”€ mod.rs
â”‚
â”œâ”€â”€ playing/
â”‚   â”œâ”€â”€ mod.rs              # æ¸¸æˆçŠ¶æ€ç®¡ç†
â”‚   â”œâ”€â”€ systems.rs          # æ¸²æŸ“ç³»ç»Ÿ
â”‚   â”œâ”€â”€ ui.rs              # UIç»„ä»¶
â”‚   â”œâ”€â”€ input.rs           # è¾“å…¥å¤„ç†
â”‚   â””â”€â”€ effects.rs         # ç‰¹æ•ˆç³»ç»Ÿ
â”‚
â”œâ”€â”€ engine/
â”‚   â”œâ”€â”€ mod.rs              # å¼•æ“æ ¸å¿ƒ
â”‚   â”œâ”€â”€ virtual_screen.rs   # è™šæ‹Ÿå±å¹•ç³»ç»Ÿ  
â”‚   â”œâ”€â”€ assets.rs          # èµ„æºç®¡ç†
â”‚   â””â”€â”€ plugin.rs          # Bevyæ’ä»¶
â”‚
â””â”€â”€ lib.rs
```

## æ ¸å¿ƒæ¶æ„è®¾è®¡

### 1. æ•°æ®å±‚æ¶æ„

```rust
// script/commands.rs - å‘½ä»¤å®šä¹‰
#[derive(Debug, Clone)]
pub enum Command {
    Say { character: String, text: String },
    ShowBackground { background: String },
    ShowCharacter { character: String, position: Option<String> },
    HideCharacter { character: String },
    PlayMusic { file: String },
    PlaySound { file: String },
    ShowChoices { choices: Vec<Choice> },
    Jump { target: String },
    SetFlag { name: String, value: bool },
    If { condition: String, then_commands: Vec<Command> },
    // ... æ›´å¤šå‘½ä»¤
}

#[derive(Debug, Clone)]
pub struct Choice {
    pub text: String,
    pub target: String,
    pub condition: Option<String>,
}

#[derive(Debug, Clone)]
pub struct Scene {
    pub id: String,
    pub commands: Vec<Command>,
}

#[derive(Debug, Clone)]
pub struct Story {
    pub scenes: HashMap<String, Scene>,
    pub characters: HashMap<String, Character>,
    pub backgrounds: HashMap<String, Background>,
    // ... å…¶ä»–èµ„æº
}
```

### 2. DSLå®å±‚

```rust
// script/dsl.rs - å®å®šä¹‰
macro_rules! story {
    ($($scene:tt)*) => {
        {
            let mut story = Story::new();
            $(
                parse_scene!(story, $scene);
            )*
            story
        }
    };
}

macro_rules! scene {
    ($story:ident, $id:literal { $($cmd:tt)* }) => {
        {
            let mut commands = Vec::new();
            $(
                parse_command!(commands, $cmd);
            )*
            $story.add_scene($id.to_string(), Scene {
                id: $id.to_string(),
                commands,
            });
        }
    };
}

macro_rules! parse_command {
    ($commands:ident, say $char:literal $text:literal) => {
        $commands.push(Command::Say {
            character: $char.to_string(),
            text: $text.to_string(),
        });
    };
    
    ($commands:ident, show_bg $bg:literal) => {
        $commands.push(Command::ShowBackground {
            background: $bg.to_string(),
        });
    };
    
    // ... æ›´å¤šå‘½ä»¤è§£æ
}
```

### 3. å‰§æƒ…å†…å®¹å±‚

```rust
// script/stories/chapter1.rs
use super::super::dsl::*;

pub fn create_chapter1() -> Story {
    story! {
        scene "start" {
            show_bg "classroom"
            show_character "alice" "center"
            say "alice" "æ¬¢è¿æ¥åˆ°æˆ‘ä»¬çš„å­¦æ ¡ï¼"
            say "alice" "æˆ‘æ˜¯å­¦ç”Ÿä¼šé•¿çˆ±ä¸½ä¸ã€‚"
            
            choices {
                "ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ " => "friendly_path"
                "å­¦ç”Ÿä¼šé•¿ï¼Ÿæ„Ÿè§‰å¾ˆå‰å®³" => "impressed_path"
                "...ï¼ˆæ²‰é»˜ï¼‰" => "shy_path"
            }
        }
        
        scene "friendly_path" {
            say "alice" "ä½ ä¹Ÿå¾ˆå¥½ç›¸å¤„å‘¢ï¼"
            say "player" "è°¢è°¢å¤¸å¥–ã€‚"
            jump "common_end"
        }
        
        scene "impressed_path" {
            say "alice" "å“ˆå“ˆï¼Œå…¶å®ä¹Ÿæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚"
            set_flag "alice_affection" +1
            jump "common_end"
        }
        
        scene "shy_path" {
            say "alice" "çœ‹èµ·æ¥ä½ æ˜¯ä¸ªå®‰é™çš„äººå‘¢ã€‚"
            say "alice" "æ²¡å…³ç³»ï¼Œæ…¢æ…¢æ¥å°±å¥½ã€‚"
            jump "common_end"
        }
        
        scene "common_end" {
            say "alice" "é‚£ä¹ˆï¼Œè¦ä¸è¦æˆ‘å¸¦ä½ å‚è§‚ä¸€ä¸‹å­¦æ ¡ï¼Ÿ"
            end_scene
        }
    }
}
```

### 4. æ¸²æŸ“æ‰§è¡Œå±‚

```rust
// playing/systems.rs
use crate::script::commands::Command;

pub fn execute_command(
    command: &Command,
    world: &mut World,
    story_state: &mut StoryState,
) -> CommandResult {
    match command {
        Command::Say { character, text } => {
            execute_dialogue(world, character, text)
        }
        
        Command::ShowBackground { background } => {
            execute_show_background(world, background)
        }
        
        Command::ShowChoices { choices } => {
            execute_show_choices(world, choices)
        }
        
        // ... å…¶ä»–å‘½ä»¤æ‰§è¡Œ
    }
}

fn execute_dialogue(
    world: &mut World,
    character: &str,
    text: &str,
) -> CommandResult {
    // æ˜¾ç¤ºå¯¹è¯æ¡†
    // è®¾ç½®è¯´è¯äºº
    // å¯åŠ¨æ‰“å­—æœºæ•ˆæœ
    // è¿”å›ç­‰å¾…è¾“å…¥çŠ¶æ€
    CommandResult::WaitForInput
}
```

## å¯¹è§†è§‰å°è¯´å¼€å‘çš„é€‚ç”¨æ€§

### âœ… å®Œå…¨å¯ä»¥æ»¡è¶³

1. **åŸºç¡€åŠŸèƒ½è¦†ç›–**
   ```rust
   // æ”¯æŒæ‰€æœ‰å¸¸è§è§†è§‰å°è¯´åŠŸèƒ½
   - å¯¹è¯ç³»ç»Ÿ âœ“
   - è§’è‰²ç«‹ç»˜ âœ“  
   - èƒŒæ™¯åˆ‡æ¢ âœ“
   - éŸ³ä¹éŸ³æ•ˆ âœ“
   - åˆ†æ”¯é€‰æ‹© âœ“
   - å­˜æ¡£è¯»æ¡£ âœ“ï¼ˆå¯æ‰©å±•ï¼‰
   - ç‰¹æ•ˆåŠ¨ç”» âœ“ï¼ˆå¯æ‰©å±•ï¼‰
   ```

2. **é«˜çº§åŠŸèƒ½æ‰©å±•æ€§**
   ```rust
   // å®¹æ˜“æ·»åŠ å¤æ‚åŠŸèƒ½
   Command::Camera { action: "zoom_in", target: "character" }
   Command::Effect { name: "fade", duration: 1.0 }
   Command::Variable { name: "love_points", op: "add", value: 5 }
   ```

### ğŸ“ˆ æ€§èƒ½ä¼˜åŠ¿

```rust
// ç¼–è¯‘æ—¶è§£æï¼Œè¿è¡Œæ—¶é«˜æ•ˆ
story! { ... } // å®åœ¨ç¼–è¯‘æ—¶å±•å¼€
    â†“
Vec<Command>   // è¿è¡Œæ—¶ç›´æ¥æ‰§è¡Œï¼Œæ— è§£æå¼€é”€
```

### ğŸ”§ æ‰©å±•ç¤ºä¾‹

```rust
// æ·»åŠ æ–°åŠŸèƒ½åªéœ€ä¸¤æ­¥

// 1. åœ¨ commands.rs æ·»åŠ å‘½ä»¤
#[derive(Debug, Clone)]
pub enum Command {
    // ç°æœ‰å‘½ä»¤...
    
    // æ–°å‘½ä»¤
    SetWeather { weather: WeatherType, transition: f32 },
}

// 2. åœ¨ dsl.rs æ·»åŠ è¯­æ³•
macro_rules! parse_command {
    // ç°æœ‰è§£æ...
    
    // æ–°è¯­æ³•
    ($commands:ident, set_weather $weather:literal $duration:literal) => {
        $commands.push(Command::SetWeather {
            weather: $weather.parse().unwrap(),
            transition: $duration,
        });
    };
}

// 3. åœ¨ stories/ ä¸­ä½¿ç”¨
scene "rainy_day" {
    set_weather "rain" 2.0
    say "alice" "ä»Šå¤©ä¸‹é›¨äº†å‘¢..."
}
```

## ä¸ä¸šç•Œå¼•æ“å¯¹æ¯”

| åŠŸèƒ½ | Ren'Py | ä½ çš„æ¶æ„ | ä¼˜åŠ¿ |
|------|--------|----------|------|
| è¯­æ³•ç®€æ´æ€§ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜…â˜… | Rustå®æ›´çµæ´» |
| æ€§èƒ½ | â˜…â˜…â˜…â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | ç¼–è¯‘æ—¶ä¼˜åŒ– |
| ç±»å‹å®‰å…¨ | â˜…â˜…â˜†â˜†â˜† | â˜…â˜…â˜…â˜…â˜… | Rustç±»å‹ç³»ç»Ÿ |
| å­¦ä¹ æ›²çº¿ | â˜…â˜…â˜…â˜…â˜† | â˜…â˜…â˜…â˜†â˜† | éœ€è¦äº†è§£Rust |
| ç”Ÿæ€ç³»ç»Ÿ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜†â˜†â˜† | æ–°å…´ç”Ÿæ€ |

## å»ºè®®çš„æœ€ç»ˆå®ç°

```rust
// lib.rs - ç»Ÿä¸€å¯¼å‡º
pub mod script {
    pub mod dsl;
    pub mod commands;
    pub mod stories;
}

pub mod engine {
    pub mod virtual_screen;
    pub mod assets;
    pub mod plugin;
}

pub mod playing {
    pub mod systems;
    pub mod ui;
    pub mod input;
}

// ä½¿ç”¨ç¤ºä¾‹
use my_vn_engine::prelude::*;

fn main() {
    App::new()
        .add_plugins(DefaultPlugins)
        .add_plugins(VisualNovelPlugin)
        .insert_resource(story::chapter1::create_story())
        .run();
}
```

## ç»“è®º

ä½ çš„ `script.rs + playing.rs` æ¶æ„è®¾è®¡**éå¸¸åˆç†**ï¼Œå¹¶ä¸”**å®Œå…¨å¯ä»¥æ»¡è¶³è§†è§‰å°è¯´å¼€å‘éœ€æ±‚**ã€‚

### ä¸»è¦ä¼˜åŠ¿ï¼š
1. âœ… **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**
2. âœ… **ä¼˜ç§€çš„æ‰©å±•æ€§** 
3. âœ… **ç¼–è¯‘æ—¶ä¼˜åŒ–**
4. âœ… **ç±»å‹å®‰å…¨ä¿éšœ**
5. âœ… **å›¢é˜Ÿåä½œå‹å¥½**

### å»ºè®®å®Œå–„ï¼š
1. ğŸ“ **ç»†åŒ–æ¨¡å—ç»“æ„**ï¼ˆå¦‚ä¸Šé¢çš„ç›®å½•å»ºè®®ï¼‰
2. ğŸ”§ **æ·»åŠ æ›´å¤šå‘½ä»¤ç±»å‹**ï¼ˆé€‰æ‹©ã€å˜é‡ã€æ¡ä»¶ç­‰ï¼‰
3. ğŸ’¾ **è€ƒè™‘å­˜æ¡£ç³»ç»Ÿ**
4. ğŸ¨ **æ·»åŠ ç‰¹æ•ˆæ”¯æŒ**

è¿™ä¸ªæ¶æ„è®¾è®¡æ€è·¯å¾ˆæ£’ï¼Œæ˜¯ä¸€ä¸ªç°ä»£åŒ–ã€é«˜æ€§èƒ½çš„è§†è§‰å°è¯´å¼•æ“åŸºç¡€ï¼
```