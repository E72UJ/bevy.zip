---
title: bevy æµ‹è¯•æ•°æ®
date: 2026-01-19 12:29:02
tags:
---
```rust
use bevy::prelude::*;
use crate::GameState;
use super::loading::{FontAssets, ImageAssets}; 
#[derive(Component)]
struct PlayingEntity;

#[derive(Component)]
struct PlayingCamera;

pub struct PlayingPlugin;

const VIRTUAL_WIDTH: f32 = 1920.0;
const VIRTUAL_HEIGHT: f32 = 1080.0;

impl Plugin for PlayingPlugin {
    fn build(&self, app: &mut App) {
        app
            .add_systems(OnEnter(GameState::Playing), setup_playing)
            .add_systems(Update, handle_playing_input.run_if(in_state(GameState::Playing)))
            .add_systems(Update, update_ui_scale.run_if(in_state(GameState::Playing)))
            .add_systems(OnExit(GameState::Playing), cleanup_playing);
    }
}

fn setup_playing(
    mut commands: Commands,
    asset_server: Res<AssetServer>,
    image_assets: Res<ImageAssets>,
    font_assets: Res<FontAssets>,
) {
    // ğŸ¥ æ‘„åƒæœº


    // ğŸ¨ UIæ ¹å®¹å™¨ - é‡‡ç”¨èœå•çš„è®¾è®¡æ¨¡å¼
    commands
        .spawn((
            PlayingEntity,
            Node {
                width: Val::Percent(100.0),     
                height: Val::Percent(100.0),
                justify_content: JustifyContent::Center, 
                align_items: AlignItems::Center,         
                ..default()
            },
            BackgroundColor(Color::srgb(0.0, 0.0, 0.0)), // è°ƒè¯•ç”¨èƒŒæ™¯
        ))
        .with_children(|parent| {
            // ğŸ¯ å›ºå®šå°ºå¯¸çš„å†…å®¹åŒºåŸŸï¼ˆä¼šè¢«UiScaleç¼©æ”¾ï¼‰
            parent
                .spawn((
                    Node {
                        width: Val::Px(VIRTUAL_WIDTH),   // âœ… å›ºå®š1920px
                        height: Val::Px(VIRTUAL_HEIGHT), // âœ… å›ºå®š1080px
                        flex_direction: FlexDirection::Column,
                        border: UiRect::all(Val::Px(2.0)), // è°ƒè¯•è¾¹æ¡†
                        ..default()
                    },
                    BackgroundColor(Color::srgb(0.2, 0.2, 0.3)),
                ))
                .with_children(|parent| {
                    // ğŸ”³ ç™½è‰²èƒŒæ™¯æ¡
                    parent.spawn((
                        Node {
                            width: Val::Percent(100.0),
                            height: Val::Px(1000.0),
                            position_type: PositionType::Absolute,
                            top: Val::Px(100.0),
                            ..default()
                        },
                    ));

 
                    parent.spawn((
                        Text::new("æ­£åœ¨æ¸¸æˆä¸­ - æŒ‰ ESC è¿”å›èœå•"),
                        Node {
                            position_type: PositionType::Absolute,
                            top: Val::Px(200.0),
                            left: Val::Px(50.0),
                            ..default()
                        },
                        TextColor(Color::BLACK),
                        TextFont {
                            font_size: 24.0,
                            ..default()
                        },
                    ));
                parent.spawn((
                    Node {
                        position_type: PositionType::Absolute,
                        bottom: Val::Px(0.0),
                        width: Val::Px(1920.0),  // è®¾ç½®å›¾ç‰‡å®½åº¦ï¼Œå¯æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´
                        height: Val::Px(1080.0), // è®¾ç½®å›¾ç‰‡é«˜åº¦ï¼Œå¯æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´
                        ..default()
                    },
                    ImageNode::new(image_assets.bg1.clone()),
                ));
                parent.spawn((
                    Node {
                        position_type: PositionType::Absolute,
                        bottom: Val::Px(400.0),
                        left: Val::Px(550.0),
                        width: Val::Px(461.0),  
                        height: Val::Px(79.0), 
                        justify_content: JustifyContent::Center, // æ°´å¹³å±…ä¸­
                        align_items: AlignItems::Center,         // å‚ç›´å±…ä¸­
                        ..default()
                    },
                    ImageNode::new(image_assets.namebox.clone()),
                ))
                .with_children(|parent| {
                    parent.spawn((
                        Text::new("ç²¾çµç‹çº¦ç‘Ÿ"),
                        TextColor(Color::WHITE),
                        Node {
                                position_type: PositionType::Absolute,
                                top: Val::Px(20.0),     
                                left: Val::Px(240.0),    
                                ..default()
                            },
                        TextFont {
                            font: font_assets.main.clone(),
                            font_size:34.0,
                            ..default()
                        },
                    ));
                });
                parent.spawn((
                    Node {
                        position_type: PositionType::Absolute,
                        bottom: Val::Px(0.0),
                        width: Val::Px(1920.0),  // è®¾ç½®å›¾ç‰‡å®½åº¦ï¼Œå¯æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´
                        height: Val::Px(360.0), // è®¾ç½®å›¾ç‰‡é«˜åº¦ï¼Œå¯æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´
                        ..default()
                    },
                    ImageNode::new(asset_server.load("textbox.png")),
                ));
                parent.spawn((
                    Node {
                        position_type: PositionType::Absolute,
                        bottom: Val::Px(0.0),
                         left: Val::Px(0.0),
                        width: Val::Px(1000.0),  // è®¾ç½®å›¾ç‰‡å®½åº¦ï¼Œå¯æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´
                        height: Val::Px(1080.0), // è®¾ç½®å›¾ç‰‡é«˜åº¦ï¼Œå¯æ ¹æ®å®é™…å›¾ç‰‡è°ƒæ•´
                        ..default()
                    },
                    ImageNode::new(asset_server.load("123.png")),
                ));
                parent.spawn((
                   Text::new("ç‚œåˆ¶ä½œ20260117"),
                        Node {
                            position_type: PositionType::Absolute,
                            bottom: Val::Px(250.0),
                            left: Val::Px(600.0),
                            ..default()
                        },
                        TextColor(Color::WHITE),
                        TextFont {
                            font: font_assets.main.clone(),
                            font_size: 38.0,
                            ..default()
                        },
                ));
                });
        });
}

fn handle_playing_input(
    keyboard_input: Res<ButtonInput<KeyCode>>,
    mut next_state: ResMut<NextState<GameState>>,
) {
    if keyboard_input.just_pressed(KeyCode::Escape) {
        next_state.set(GameState::Menu);
    }
}

fn cleanup_playing(
    mut commands: Commands,
    query: Query<Entity, With<PlayingEntity>>,
) {
    for entity in query.iter() {
        commands.entity(entity).despawn();
    }
    println!("é€€å‡ºæ¸¸æˆ");
}

fn update_ui_scale(
    windows: Query<&Window>,
    mut ui_scale: ResMut<UiScale>,
) {
    if let Some(window) = windows.iter().next() {
        let window_width = window.width();
        let window_height = window.height();
        
        let scale_x = window_width / VIRTUAL_WIDTH;
        let scale_y = window_height / VIRTUAL_HEIGHT;
        let scale = scale_x.min(scale_y);
        
        ui_scale.0 = scale;
        
        // è°ƒè¯•ä¿¡æ¯
        // println!("çª—å£: {}x{}, ç¼©æ”¾: {:.2}", window_width, window_height, scale);
    }
}
```