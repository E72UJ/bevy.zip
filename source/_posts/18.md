---
title: bevy 布局测试
date: 2025-12-31 19:22:27
tags:
---
```rust
use bevy::prelude::*;

const VIRTUAL_WIDTH: f32 = 1920.0;
const VIRTUAL_HEIGHT: f32 = 1080.0;

// 字体资源
#[derive(Resource)]
struct FontAssets {
    default: Handle<Font>,
}

// 字体大小枚举
#[derive(Clone, Copy)]
enum FontSize {
    Small,
    Normal,
    Large,
    XLarge,
    XXLarge,
}

impl FontSize {
    fn value(self) -> f32 {
        match self {
            FontSize::Small => 16.0,
            FontSize::Normal => 24.0,
            FontSize::Large => 32.0,
            FontSize::XLarge => 48.0,
            FontSize::XXLarge => 64.0,
        }
    }
}

// 字体样式
#[derive(Clone, Copy)]
enum FontStyle {
    Normal,
    Bold,
    Italic,
    Chinese,
}

// 字体设置结构体
struct FontConfig {
    style: FontStyle,
    size: FontSize,
    color: Color,
}

impl Default for FontConfig {
    fn default() -> Self {
        Self {
            style: FontStyle::Normal,
            size: FontSize::Normal,
            color: Color::WHITE,
        }
    }
}

// 辅助函数：创建文本
fn create_text(
    text: &str,
    config: FontConfig,
    font_assets: &FontAssets,
) -> (Text, TextFont, TextColor) {
    (
        Text::new(text),
        TextFont {
            font: font_assets.default.clone(),
            font_size: config.size.value(),
            ..default()
        },
        TextColor(config.color),
    )
}

fn main() {
    App::new()
        .add_plugins(DefaultPlugins)
        .add_systems(Startup, (load_fonts, setup).chain()) // 确保字体先加载
        .add_systems(Update, update_ui_scale)
        .run();
}

fn load_fonts(mut commands: Commands, asset_server: Res<AssetServer>) {
    let font_assets = FontAssets {
        default: asset_server.load("fonts/SarasaFixedHC-Light.ttf"),
    };
    
    commands.insert_resource(font_assets);
}

fn setup(
    mut commands: Commands, 
    asset_server: Res<AssetServer>,
    font_assets: Res<FontAssets>,
) {
    // 相机
    commands.spawn((Camera2d, Camera::default()));
    
    // UI 根容器
    commands
        .spawn((
            Node {
                width: Val::Percent(100.0),
                height: Val::Percent(100.0),
                justify_content: JustifyContent::Center,
                align_items: AlignItems::Center,
                ..default()
            },
            BackgroundColor(Color::BLACK),
        ))
        .with_children(|parent| {
            // 固定尺寸的内容区域
            parent
                .spawn((
                    Node {
                        width: Val::Px(VIRTUAL_WIDTH),
                        height: Val::Px(VIRTUAL_HEIGHT),
                        flex_direction: FlexDirection::Column,
                        justify_content: JustifyContent::Center,
                        align_items: AlignItems::Center,
                        ..default()
                    },
                    BackgroundColor(Color::srgb(0.2, 0.2, 0.2)),
                ))
                .with_children(|parent| {
                    // 背景图片
                    parent.spawn((
                        Node {
                            width: Val::Px(1920.0),
                            height: Val::Px(1080.0),
                            position_type: PositionType::Absolute,
                            left: Val::Px(0.0),
                            top: Val::Px(0.0),
                            ..default()
                        },
                        ImageNode::new(asset_server.load("gui/game3.png")),
                        BackgroundColor(Color::srgba(1.0, 1.0, 1.0, 0.1)),
                    ));

                    // 示例 1：普通按钮
                    parent.spawn((
                        Node {
                            width: Val::Px(200.0),
                            height: Val::Px(80.0),
                            position_type: PositionType::Absolute,
                            left: Val::Px(100.0),
                            top: Val::Px(100.0),
                            justify_content: JustifyContent::Center,
                            align_items: AlignItems::Center,
                            ..default()
                        },
                        BackgroundColor(Color::srgb(0.8, 0.2, 0.2)),
                    ))
                    .with_children(|parent| {
                        let (text, font, color) = create_text(
                            "普通按钮",
                            FontConfig {
                                style: FontStyle::Normal,
                                size: FontSize::Normal,
                                color: Color::WHITE,
                            },
                            &font_assets,
                        );
                        parent.spawn((text, font, color));
                    });
                    
                    // 示例 2：大标题
                    parent.spawn((
                        Node {
                            position_type: PositionType::Absolute,
                            left: Val::Px(100.0),
                            top: Val::Px(300.0),
                            justify_content: JustifyContent::Center,
                            align_items: AlignItems::Center,
                            ..default()
                        },
                    ))
                    .with_children(|parent| {
                        let (text, font, color) = create_text(
                            "大标题文本",
                            FontConfig {
                                style: FontStyle::Bold,
                                size: FontSize::XLarge,
                                color: Color::srgb(1.0, 0.8, 0.0), // 金色
                            },
                            &font_assets,
                        );
                        parent.spawn((text, font, color));
                    });

                    // 示例 3：小文本
                    parent.spawn((
                        Node {
                            position_type: PositionType::Absolute,
                            left: Val::Px(100.0),
                            top: Val::Px(400.0),
                            justify_content: JustifyContent::Center,
                            align_items: AlignItems::Center,
                            ..default()
                        },
                    ))
                    .with_children(|parent| {
                        let (text, font, color) = create_text(
                            "这是小号文本",
                            FontConfig {
                                style: FontStyle::Italic,
                                size: FontSize::Small,
                                color: Color::srgb(0.7, 0.7, 0.7), // 灰色
                            },
                            &font_assets,
                        );
                        parent.spawn((text, font, color));
                    });

                    // 示例 4：中文文本
                    parent.spawn((
                        Node {
                            position_type: PositionType::Absolute,
                            left: Val::Px(100.0),
                            top: Val::Px(500.0),
                            justify_content: JustifyContent::Center,
                            align_items: AlignItems::Center,
                            ..default()
                        },
                    ))
                    .with_children(|parent| {
                        let (text, font, color) = create_text(
                            "中文字体测试",
                            FontConfig {
                                style: FontStyle::Chinese,
                                size: FontSize::Large,
                                color: Color::srgb(0.2, 0.8, 0.2), // 绿色
                            },
                            &font_assets,
                        );
                        parent.spawn((text, font, color));
                    });

                    // 示例 5：右下角按钮
                    parent.spawn((
                        Node {
                            width: Val::Px(150.0),
                            height: Val::Px(60.0),
                            position_type: PositionType::Absolute,
                            right: Val::Px(50.0),
                            bottom: Val::Px(50.0),
                            justify_content: JustifyContent::Center,
                            align_items: AlignItems::Center,
                            ..default()
                        },
                        BackgroundColor(Color::srgb(0.2, 0.8, 0.2)),
                    ))
                    .with_children(|parent| {
                        let (text, font, color) = create_text(
                            "右下角",
                            FontConfig {
                                style: FontStyle::Bold,
                                size: FontSize::Normal,
                                color: Color::BLACK,
                            },
                            &font_assets,
                        );
                        parent.spawn((text, font, color));
                    });

                    // 示例 6：超大标题
                    parent.spawn((
                        Node {
                            position_type: PositionType::Absolute,
                            left: Val::Px(400.0),
                            top: Val::Px(200.0),
                            justify_content: JustifyContent::Center,
                            align_items: AlignItems::Center,
                            ..default()
                        },
                    ))
                    .with_children(|parent| {
                        let (text, font, color) = create_text(
                            "GAME",
                            FontConfig {
                                style: FontStyle::Bold,
                                size: FontSize::XXLarge,
                                color: Color::srgb(0.8, 0.1, 0.8), // 紫色
                            },
                            &font_assets,
                        );
                        parent.spawn((text, font, color));
                    });
                });
        });
}

fn update_ui_scale(
    windows: Query<&Window>,
    mut ui_scale: ResMut<UiScale>,
) {
    if let Some(window) = windows.iter().next() {
        let window_width = window.width();
        let window_height = window.height();
        
        // 计算缩放比例，保持宽高比
        let scale_x = window_width / VIRTUAL_WIDTH;
        let scale_y = window_height / VIRTUAL_HEIGHT;
        let scale = scale_x.min(scale_y);
        
        ui_scale.0 = scale;
    }
}
```
```rust
    // ===== UI菜单层 =====
    commands.spawn((
        SceneEntity,
        Node {
            width: Val::Percent(100.0),
            height: Val::Percent(100.0),
            flex_direction: FlexDirection::Row,
            ..default()
        },
        // 使用高Z-index确保UI在Sprite之上
        GlobalZIndex(100),
        children![
            // 左侧菜单区域
            (
                Node {
                    position_type: PositionType::Absolute,
                    width: Val::Percent(50.0),
                    height: Val::Percent(100.0),
                    align_items: AlignItems::Start,
                    justify_content: JustifyContent::Center,
                    flex_direction: FlexDirection::Column,
                    padding: UiRect {
                        left: Val::Px(50.0),
                        right: Val::Px(30.0),
                        top: Val::Px(0.0),
                        bottom: Val::Px(70.0),
                    },
                    row_gap: Val::Px(20.0),
                    ..default()
                },
                ElementId("leftbox".to_string()), // 设置元素ID
                children![
                    // Logo文本
                    (
                        Text::new(logo_text),
                        TextFont {
                            font: assets.load("fonts/SarasaFixedHC-Regular.ttf"),
                            font_size: logo_font_size,
                            ..default()
                        },
                        TextColor(logo_text_color),
                        Node {
                            margin: UiRect {
                                left: Val::Px(20.0),
                                right: Val::Px(0.0),
                                top: Val::Px(0.0),
                                bottom: Val::Px(0.0),
                            },
                            ..default()
                        },
                        GlobalZIndex(110), // 比菜单容器更高
                    ),
                    // 菜单按钮
                    create_button(&assets, "开始游戏", StartGameButton),
                    create_button(&assets, "关于", AboutButton),
                    create_button(&assets, "帮助", HelpButton),
                    create_button(&assets, "退出", ExitGameButton),
                ],
            ),
            // 右侧透明区域（用于保持布局但不遮挡背景）
            (
                Node {
                    width: Val::Percent(50.0),
                    height: Val::Percent(100.0),
                    // 不设置背景，保持透明
                    ..default()
                },
            ),
        ],
    ));
}
fn create_button(asset_server: &AssetServer, text: &str, button_type: impl Component) -> impl Bundle {
    
    (
        button_type,
        Button,
        Node {
            width: Val::Px(200.0),
            height: Val::Px(35.0),
            // border: UiRect::all(Val::Px(2.0)),
            margin: UiRect {
                left: Val::Px(14.0),
                right: Val::Px(0.0),
                top: Val::Px(0.0),
                bottom: Val::Px(0.0),
            },
            justify_content: JustifyContent::Center,
            align_items: AlignItems::Center,
            ..default()
        },
        // BorderColor::all(Color::WHITE),
        // BackgroundColor(None),
        BackgroundColor(Color::srgba(0.0, 0.0, 0.0, 0.0)), // 完全透明
        GlobalZIndex(55),
        children![(
            Text::new(text),
            TextFont {
                font: asset_server.load("fonts/SarasaFixedHC-Light.ttf"),
                font_size: 26.0,
                ..default()
            },
            // TextColor(Color::srgb(0.9, 0.9, 0.9)),
            
            // TextShadow::default(),
        )]
    )
}
```